name: Audit VPN (Dependency-Check)

on:
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull VPN image
        run: |
          docker pull openvpn/openvpn-as:latest

      - name: Create container (no start)
        run: |
          docker create --name vpn-audit openvpn/openvpn-as:latest

      # ✅ FIX ROBUSTE : on exporte, on liste, on filtre, puis on extrait UNIQUEMENT les chemins utiles
      - name: Export container filesystem (filtered extraction)
        run: |
          set -euo pipefail

          mkdir -p rootfs
          docker export vpn-audit -o vpn-audit.tar

          # 1) Liste le contenu de l'archive
          tar -tf vpn-audit.tar > all_files.txt

          # 2) Garde uniquement les chemins utiles au scan (libs + binaires)
          #    (et on évite totalement run/, dev/, proc/, sys/)
          grep -E '^(lib/|usr/lib/|usr/sbin/|usr/bin/)' all_files.txt > files_to_extract.txt || true

          echo "Nombre de fichiers à extraire:"
          wc -l files_to_extract.txt || true

          # 3) Extrait uniquement ces fichiers
          tar -xf vpn-audit.tar -C rootfs --files-from=files_to_extract.txt

      - name: Run Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "Audit-VPN-Entreprise"
          path: "rootfs"
          format: "HTML"
          out: "reports"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: rapport-audit-vpn
          path: reports

      - name: Cleanup (optional)
        if: always()
        run: |
          docker rm -f vpn-audit 2>/dev/null || true
